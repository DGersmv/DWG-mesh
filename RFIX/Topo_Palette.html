<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>DWG Mesh — Топо Mesh из DWG</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #efefef;
      margin: 0;
      color: #2f2f2f;
      padding: 10px;
      font-size: 12px;
      line-height: 1.35;
    }
    h1 {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 10px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .section { margin-bottom: 10px; }
    .section-title {
      font-weight: 600;
      margin-bottom: 5px;
      text-transform: uppercase;
      font-size: 11px;
      color: #54524f;
    }
    .divider {
      height: 1px;
      background: #c7c3bd;
      margin: 8px 0;
    }
    .form-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
    }
    .form-row label {
      width: 155px;
      flex-shrink: 0;
      font-size: 11px;
      color: #3a3a3a;
    }
    .form-row select,
    .form-row input[type="number"],
    .form-row input[type="text"] {
      flex: 1;
      padding: 3px 5px;
      border: 1px solid #ada9a4;
      border-radius: 2px;
      background: #ffffff;
      font-size: 12px;
    }
    .sep-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .sep-group label { font-size: 12px; cursor: pointer; width: auto; }
    .preview-box {
      flex: 1;
      padding: 3px 6px;
      border: 1px solid #c0beb9;
      background: #f9f8f6;
      font-size: 11px;
      min-height: 22px;
      color: #444;
      font-family: monospace;
    }
    .preview-ok  { color: #2a6e00; font-weight: 600; }
    .preview-err { color: #900; }
    .btn {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid #a8a5a2;
      border-radius: 2px;
      background: #dcd9d4;
      color: #2f2f2f;
      font-size: 12px;
      cursor: pointer;
      box-shadow: inset 0 1px 0 #f5f4f2;
      text-align: center;
      width: 100%;
    }
    .btn:hover   { background: #e7e4de; }
    .btn:active  { background: #cac7c2; }
    .btn:disabled { background: #e2e0de; color: #999; cursor: default; }
    .btn-primary { font-weight: 600; }
    .info-box {
      padding: 6px 7px;
      border: 1px solid #c0beb9;
      background: #f9f8f6;
      font-size: 11px;
      line-height: 1.5;
      min-height: 24px;
    }
    .info-ok  { color: #2a6e00; font-weight: 600; }
    .info-err { color: #900; font-weight: 600; }
  </style>

  <script>
    function $(id) { return document.getElementById(id); }

    function ensureACAPI(fnName) {
      const api = window.ACAPI;
      if (!api || typeof api[fnName] !== 'function') return null;
      return api[fnName].bind(api);
    }

    function setInfo(text, cls) {
      const box = $('infoBox');
      if (!box) return;
      box.textContent = text;
      box.className = 'info-box' + (cls ? ' ' + cls : '');
    }

    // ── Инициализация ────────────────────────────────────────────────────────

    // helper: wait for ACAPI to appear, retrying for a short time
    function waitForACAPI(maxRetries = 20, interval = 50) {
      return new Promise((resolve) => {
        let tries = 0;
        function check() {
          const fn = ensureACAPI('GetLayerList');
          if (fn || tries >= maxRetries) {
            resolve(fn);
          } else {
            tries++;
            setTimeout(check, interval);
          }
        }
        check();
      });
    }

    async function init() {
      setInfo('Инициализация...', '');
      const fn = await waitForACAPI();
      if (!fn) {
        setInfo('ACAPI недоступен после ожидания', 'info-err');
        return;
      }

      await populateLayers();
      await populateStories();
      setInfo('', '');
    }

    async function populateLayers() {
  const fn = ensureACAPI('GetLayerList');
  if (!fn) { setInfo('ACAPI недоступен', 'info-err'); return; }

  try {
    const layersData = await fn(); // [ [name, layerIndex], ... ]
    if (!Array.isArray(layersData)) throw new Error('GetLayerList вернул не массив');

    const layers = layersData
      .filter(it => Array.isArray(it) && it.length >= 2)
      .map(it => ({ name: String(it[0] ?? ''), index: Number(it[1]) }))
      .filter(x => x.name.length > 0 && !Number.isNaN(x.index));

    fillSelect('layerSelect',     layers, l => l.index, l => l.name);
    fillSelect('meshLayerSelect', layers, l => l.index, l => l.name);
  } catch(e) {
    setInfo('Ошибка загрузки слоёв: ' + e, 'info-err');
  }
}

async function populateStories() {
  const fn = ensureACAPI('GetStoryList');
  if (!fn) return;

  try {
    const storiesData = await fn(); // [ [name, storyIndex], ... ]
    if (!Array.isArray(storiesData)) return;

    const stories = storiesData
      .filter(it => Array.isArray(it) && it.length >= 2)
      .map(it => ({ name: String(it[0] ?? ''), index: Number(it[1]) }))
      .filter(x => x.name.length > 0 && !Number.isNaN(x.index));

    fillSelect('storySelect', stories, s => s.index, s => s.name);
  } catch(e) { /* тихо */ }
}

    function fillSelect(id, items, valFn, textFn) {
      const sel = $(id);
      if (!sel) return;
      sel.innerHTML = '';
      items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = valFn(item);
        opt.textContent = textFn(item);
        sel.appendChild(opt);
      });
    }

    // ── Парсинг / превью ─────────────────────────────────────────────────────

    async function loadSample() {
      const fn = ensureACAPI('GetSampleElevationText');
      if (!fn) { setInfo('ACAPI недоступен', 'info-err'); return; }

      const layerIdx = parseInt($('layerSelect').value, 10);
      if (isNaN(layerIdx)) return;

      $('sampleRaw').textContent = '...';
      $('sampleResult').textContent = '';
      $('sampleResult').className = '';

      try {
        const sample = await fn(layerIdx);
        $('sampleRaw').textContent = sample;
        updatePreview(sample);
      } catch(e) {
        $('sampleRaw').textContent = '(ошибка)';
      }
    }

    function updatePreview(rawText) {
      if (!rawText || rawText === '...' || rawText === '(ошибка)') return;
      const sep = document.querySelector('input[name="sep"]:checked')?.value || '.';
      const val = parseElevation(rawText, sep);
      const box = $('sampleResult');
      if (val !== null) {
        box.textContent = '→ ' + val.toFixed(3) + ' м';
        box.className = 'preview-ok';
      } else {
        box.textContent = '→ не распознано';
        box.className = 'preview-err';
      }
    }

    // Зеркалит логику C++ ParseElevationText
    function parseElevation(text, sep) {
      text = text.trim();
      let neg = false;
      if (text[0] === '+') text = text.slice(1);
      else if (text[0] === '-') { neg = true; text = text.slice(1); }
      if (sep === ',') text = text.replace(',', '.');
      const val = parseFloat(text);
      if (isNaN(val)) return null;
      return neg ? -val : val;
    }

    function onLayerChange() { loadSample(); }
    function onSepChange()   {
      const raw = $('sampleRaw').textContent;
      if (raw && raw !== '...' && raw !== '(ошибка)' && raw !== '(нажмите «Загрузить»)')
        updatePreview(raw);
    }

    // ── Создание Mesh ────────────────────────────────────────────────────────

    async function createTopoMesh() {
      const fn = ensureACAPI('CreateTopoMesh');
      if (!fn) { setInfo('ACAPI.CreateTopoMesh недоступен', 'info-err'); return; }

      const layerIdx   = parseInt($('layerSelect').value,      10);
      const storyIdx   = parseInt($('storySelect').value,      10);
      const meshLayer  = parseInt($('meshLayerSelect').value,  10);
      const radius     = parseFloat($('radius').value)         || 3000;
      const bboxOffset = parseFloat($('bboxOffset').value)     || 1000;
      const meshName   = $('meshName').value.trim()            || 'TopoMesh';
      const sep        = document.querySelector('input[name="sep"]:checked')?.value || '.';

      if (isNaN(layerIdx)) { setInfo('Выберите слой с отметками', 'info-err'); return; }
      if (radius <= 0)     { setInfo('Радиус поиска должен быть > 0', 'info-err'); return; }

      const payload = JSON.stringify({
        layerIdx:   layerIdx,
        radius:     radius,
        separator:  sep,
        mFactor:    1,
        mmFactor:   1000,
        storyIdx:   isNaN(storyIdx) ? 0 : storyIdx,
        bboxOffset: bboxOffset,
        meshName:   meshName,
        meshLayer:  isNaN(meshLayer) ? 0 : meshLayer
      });

      setInfo('Создание Mesh...');
      $('btnCreate').disabled = true;

      try {
        const ok = await fn(payload);
        setInfo(ok ? 'Mesh создан успешно!' : 'Не удалось создать Mesh. Проверьте слой и параметры.', ok ? 'info-ok' : 'info-err');
      } catch(e) {
        setInfo('Ошибка: ' + e, 'info-err');
      } finally {
        $('btnCreate').disabled = false;
      }
    }

    window.addEventListener('load', init);
  </script>
</head>
<body>
  <h1>Топо Mesh из DWG</h1>

  <!-- ── Источник ── -->
  <div class="section">
    <div class="section-title">Источник</div>
    <div class="form-row">
      <label for="layerSelect">Слой с отметками:</label>
      <select id="layerSelect" onchange="onLayerChange()"></select>
    </div>
    <div class="form-row">
      <label for="radius">Радиус поиска текста (мм):</label>
      <input type="number" id="radius" value="3000" min="1" step="100">
    </div>
    <button class="btn" onclick="loadSample()" style="margin-top:3px;">
      Загрузить пример с слоя
    </button>
  </div>

  <div class="divider"></div>

  <!-- ── Парсинг ── -->
  <div class="section">
    <div class="section-title">Парсинг формата</div>
    <div class="form-row">
      <label>Пример текста:</label>
      <span id="sampleRaw" class="preview-box">(нажмите «Загрузить»)</span>
    </div>
    <div class="form-row">
      <label>Разделитель:</label>
      <div class="sep-group">
        <label><input type="radio" name="sep" value="." checked onchange="onSepChange()"> точка &nbsp;<code>14.200</code></label>
        <label><input type="radio" name="sep" value="," onchange="onSepChange()"> запятая &nbsp;<code>14,200</code></label>
      </div>
    </div>
    <div class="form-row">
      <label>Результат:</label>
      <span id="sampleResult" style="flex:1; font-size:12px;"></span>
    </div>
  </div>

  <div class="divider"></div>

  <!-- ── Параметры Mesh ── -->
  <div class="section">
    <div class="section-title">Параметры Mesh</div>
    <div class="form-row">
      <label for="storySelect">Этаж (reference plane):</label>
      <select id="storySelect"></select>
    </div>
    <div class="form-row">
      <label for="meshLayerSelect">Слой для Mesh:</label>
      <select id="meshLayerSelect"></select>
    </div>
    <div class="form-row">
      <label for="bboxOffset">Отступ контура (мм):</label>
      <input type="number" id="bboxOffset" value="1000" min="0" step="100">
    </div>
    <div class="form-row">
      <label for="meshName">Имя элемента:</label>
      <input type="text" id="meshName" value="TopoMesh" maxlength="64">
    </div>
  </div>

  <div class="divider"></div>

  <!-- ── Создать ── -->
  <div class="section">
    <button id="btnCreate" class="btn btn-primary" onclick="createTopoMesh()">
      Создать Topo Mesh
    </button>
  </div>

  <!-- ── Статус ── -->
  <div id="infoBox" class="info-box">
    Выберите слой, загрузите пример, проверьте парсинг и нажмите «Создать».
  </div>

</body>
</html>
